{% extends 'base.html' %}
{% block content %}
<style>
    .results-container {
        min-height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 24px 12px;
    }

    .results-card {
        width: 100%;
        max-width: 600px;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.07);
        padding: 2.5rem 2rem;
        border: 1px solid #f0f0f0;
        overflow-y: auto;
        max-height: 80vh;
    }

    .results-title {
        font-size: 2rem;
        font-weight: 800;
        color: #1a1a2e;
        margin-bottom: 0.5rem;
        text-align: center;
        font-family: 'Inter', sans-serif;
    }

    .results-subtitle {
        color: #888;
        margin-bottom: 2rem;
        text-align: center;
        font-size: 1.1rem;
        font-family: 'Inter', sans-serif;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a1a2e;
        margin: 2rem 0 1rem 0;
        text-align: center;
        font-family: 'Inter', sans-serif;
    }

    .ride-item {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 0.8rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        font-family: 'Inter', sans-serif;
        transition: box-shadow 0.2s;
    }

    .ride-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .ride-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .ride-info {
        flex: 1;
    }

    .ride-title {
        font-weight: 700;
        color: #1a1a2e;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .ride-details {
        color: #666;
        font-size: 0.95rem;
        line-height: 1.4;
    }

    .ride-price {
        background: #ff7f32;
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        font-weight: 600;
        font-size: 0.9rem;
        text-align: center;
        min-width: 80px;
    }

    .book-btn {
        background: #ff7f32;
        color: #fff;
        border: none;
        border-radius: 2rem;
        padding: 0.75rem 2rem;
        font-size: 1rem;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        transition: background 0.2s;
        box-shadow: 0 4px 24px 0 rgba(44, 62, 80, 0.08);
        cursor: pointer;
        margin-top: 1rem;
    }

    .book-btn:hover {
        background: #ff9a5a;
    }

    .bus-item {
        background: #f8fafc;
        border: 1px solid #e0e0e0;
        border-radius: 0.8rem;
        padding: 1.5rem;
        margin-bottom: 1rem;
        font-family: 'Inter', sans-serif;
        transition: box-shadow 0.2s;
    }

    .bus-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .bus-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .bus-info {
        flex: 1;
    }

    .bus-title {
        font-weight: 700;
        color: #1a1a2e;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }

    .bus-details {
        color: #666;
        font-size: 0.95rem;
        line-height: 1.4;
    }

    .view-stops-btn {
        background: #ff7f32 !important;
        color: white !important;
        border: none !important;
        padding: 0.5rem 1rem !important;
        border-radius: 1.5rem !important;
        font-weight: 600 !important;
        font-family: 'Inter', sans-serif !important;
        transition: all 0.2s !important;
        box-shadow: 0 2px 8px rgba(255, 127, 50, 0.2) !important;
        cursor: pointer;
    }
    
    .view-stops-btn:hover {
        background: #ff9a5a !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(255, 127, 50, 0.3) !important;
    }

    .empty-state {
        text-align: center;
        color: #888;
        font-family: 'Inter', sans-serif;
        padding: 2rem;
        background: #f8fafc;
        border-radius: 0.8rem;
        border: 1px dashed #e0e0e0;
    }

    .divider {
        height: 1px;
        background: #e0e0e0;
        margin: 2rem 0;
        border-radius: 1px;
    }

    .map-title {
        position: absolute;
        top: 15px;
        left: 20px;
        z-index: 1001;
        background: rgba(255, 255, 255, 0.95);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 700;
        font-family: 'Inter', sans-serif;
        color: #1a1a2e;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    @media (max-width: 768px) {
        #mapModal {
            padding: 10px !important;
        }
        
        #mapModal > div {
            max-width: 100% !important;
            max-height: 100% !important;
            border-radius: 10px !important;
        }
    }

    @media (max-width: 600px) {
        .results-card {
            padding: 2rem 1.5rem;
            margin: 0 0.5rem;
        }
        
        .results-title {
            font-size: 1.75rem;
        }

        .ride-header, .bus-header {
            flex-direction: column;
            gap: 1rem;
        }

        .ride-price {
            align-self: flex-start;
        }
    }
</style>

<div class="results-container">
    <div class="results-card">
        <h2 class="results-title">Available Rides</h2>
        <p class="results-subtitle">From <strong>{{ start }}</strong> to <strong>{{ end }}</strong> after {{ departure_time }}</p>

        {% if rides %}
            <div class="section-title">Car Rides</div>
            {% for ride in rides %}
                <div class="ride-item">
                    <div class="ride-header">
                        <div class="ride-info">
                            <div class="ride-title">{{ ride.driver.username }}'s Ride</div>
                            <div class="ride-details">
                                <strong>From:</strong> {{ ride.start_location }}<br>
                                <strong>To:</strong> {{ ride.end_location }}<br>
                                <strong>Departure:</strong> {{ ride.departure_time|date:"M d, Y H:i" }}<br>
                                <strong>Seats Left:</strong> {{ ride.available_seats }}
                            </div>
                        </div>
                        <div class="ride-price">{{ ride.seat_price }} ден</div>
                    </div>
                    <form action="{% url 'rides:book' ride.id %}" method="get" style="display:inline;">
                        <button type="submit" class="book-btn">Book Ride</button>
                    </form>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p>No available car rides match your search.</p>
            </div>
        {% endif %}

        <!-- JSP Bus results -->
        <div class="divider"></div>
        <div class="section-title">JSP Bus Options</div>

        {% if buses %}
            {% for option in buses %}
                <div class="bus-item">
                    <div class="bus-header">
                        <div class="bus-info">
                            <div class="bus-title">Bus {{ option.bus.name }}</div>
                            <div class="bus-details">
                                <strong>From:</strong> {{ option.start }}<br>
                                <strong>Departs At:</strong> {{ option.start_time|time:"H:i" }}
                            </div>
                        </div>
                        <button class="view-stops-btn" data-bus="{{ option.bus.name }}">View stops</button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p>No available buses match your search.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- MAP MODAL -->
<div id="mapModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center; padding:20px; box-sizing:border-box;">
    <div style="position:relative; width:100%; max-width:800px; height:100%; max-height:600px; background:#fff; border-radius:15px; overflow:hidden; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div class="map-title" id="mapTitle">Bus Route</div>
        <div style="position:absolute; top:15px; right:15px; z-index:1001; display:flex; gap:10px;">
            <button onclick="closeMapModal()" style="background:#ff7f32; color:#fff; border:none; padding:0.75rem 1.5rem; border-radius:8px; font-weight:600; cursor:pointer; font-family:'Inter',sans-serif; box-shadow:0 2px 8px rgba(255,127,50,0.3); transition:all 0.2s;" onmouseover="this.style.background='#ff9a5a'" onmouseout="this.style.background='#ff7f32'">Close</button>
        </div>
        <div id="map" style="width:100%; height:100%;"></div>
    </div>
</div>

<!-- LEAFLET CSS + JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- MAP SCRIPT -->
<script>
    const STOP_COORDINATES = {{ stop_coordinates_json|safe }};
    const BUS_STOPS = {{ bus_stops_json|safe }};

    function closeMapModal() {
        document.getElementById("mapModal").style.display = "none";
        if (window.map) {
            window.map.remove();
        }
    }

    document.querySelectorAll('.view-stops-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const fullBusName = btn.dataset.bus;
            console.log('Full bus name:', fullBusName);
            
            // Extract bus number from "Bus 22" -> "22"
            const busNumber = fullBusName.replace('Bus ', '');
            console.log('Extracted bus number:', busNumber);
            console.log('Available bus stops keys:', Object.keys(BUS_STOPS));
            console.log('Looking for stops for bus:', busNumber);
            
            // Try to get stops using the extracted number
            const stops = BUS_STOPS[busNumber];
            
            if (!stops) {
                alert("No stops found for this bus.\nFull bus name: " + fullBusName + "\nExtracted number: " + busNumber + "\nAvailable buses: " + Object.keys(BUS_STOPS).join(', '));
                return;
            }

            // Set modal title
            document.getElementById("mapTitle").textContent = `Bus ${busNumber} Route`;
            document.getElementById("mapModal").style.display = "flex";

            // Initialize map
            const map = L.map('map');
            window.map = map;

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Create markers for all stops
            const markers = [];
            stops.forEach((stopName, index) => {
                const coords = STOP_COORDINATES[stopName];
                if (coords) {
                    const marker = L.marker(coords).addTo(map);
                    marker.bindPopup(`<b>${index + 1}. ${stopName}</b>`);
                    markers.push(marker);
                }
            });

            // Fit map to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                // Fallback to Skopje center if no markers
                map.setView([41.9981, 21.4254], 13);
            }
        });
    });
</script>
{% endblock %}
